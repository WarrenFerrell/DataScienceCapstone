---
title: "Capstone Milestone Report"
author: "Warren T Ferrell Jewell"
date: "November 16, 2016"
output:
  html_document: default
  pdf_document: default
---

## About the Data
pulled list of most common english words from https://github.com/first20hours/google-10000-english

```{r knitrOpts, include=FALSE}
enableJIT(3)  # just in time compiling (compile each function the first time it is run
setCompilerOptions(optimize = 3)

knitr::opts_chunk$set(echo = TRUE, include = TRUE, message=FALSE, warning=FALSE)
```

```{r setup, include=FALSE}
#rm(list=ls())

mainPath = "C:/Users/warre/GitHub/CAPSTONE/"
setwd(mainPath)
cleanDataPath = "cleanedData/en_us/ASCII/"
scriptPath = paste0(mainPath, 'scripts/')
objPath = paste0(mainPath, 'objects/')

cacheObj = TRUE
nVocabulary =  10000
cleanFreq = 5E6
nTopGrams = 5
minFreq = 10
maxGram = 3
nPartitions = 100 # work with subset of data from each set
nPartitionsToUse = 1
trainingDataPath = paste0(cleanDataPath, nPartitions, 'Partitions/')
```

library(tm); library(ggplot2); library(dplyr); library(compiler); library(methods)
library(foreach); library(doParallel); library(microbenchmark); library(fastmatch)

##Common Terms
Using on the top 10000 terms 

```{r topTerms, echo = FALSE}
termFilePath = 'data/en_US/google-10000-english-usa-no-swears.txt'
if(!file.exists(paste0(mainPath, termFilePath))) {
    freqTermURL <- "https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-usa-no-swears.txt"
    download.file(freqTermURL, termFilePath)
}
         
termsToInclude = ReadLines2(termFilePath)[1:nVocabulary]      #, ".", "?", "!") 
```

## Load Data
Generate trees by traversing each line in file. Use a environment of environments (a hash table) to dramatically reduce the lookup time for the tree. Each term has a list
that points to terms that have been seen following that term. The final term in the
gram is stored in the list with a frequency variable that is used to rank which
is the most likely gram during prediction. Because this method doesn't grab the 
frequency of every single gram (something that requires more memory than a 16GB RAM
laptop can provide) it sets a maximum allowable memory for the tree and then
trims all grams that don't meet a set minimum frequency. This method can lose
low frequency grams with the highest frequency that could be lost being equal to
the number of times that the tree is trimed.

```{r SourceLoadData, include=FALSE, echo=FALSE}
sourceLoadData <- function()
{
    source(paste0(scriptPath, 'WriteASCIIData.R'))
    source(paste0(scriptPath, 'SplitDataIntoPartitions.R'))
    
    source(paste0(scriptPath, 'treeMerge.R'))
    source(paste0(scriptPath, 'nGramTreeClass.R'))
    source(paste0(scriptPath, 'env2list.R'))
    #WriteASCIIDataDriver("data/en_US/", cleanDataPath)
    #WriteSubsetDriver(cleanDataPath, paste0(cleanDataPath, nPartitions, "Partitions/"))
}
```

```{r loadData, echo=FALSE}

# objPre <- paste0(objPath, 'refs/inPlace/', nPartitionsToUse,  "PartOf", nPartitions, 'Vocab', nVocabulary, 'clnFrq', cleanFreq, 'mnFrq', minFreq, 'nTpGrms', nTopGrams, 'mxGrm', maxGram)

# readGrams <- function(){ GetGramsFromFile(trainingDataPath, termsToInclude, nPartitionsToUse) }
#Rprof('topGrams.out')
source(paste0(scriptPath, 'refs/refs2Tree.R'))
system.time({ grams <-  GetGramsFromFile(trainingDataPath, termsToInclude, nPartitionsToUse) }) 
#Rprof(NULL)
# summaryRprof('topGrams.out')
# proftable('topGrams.out')



```

## Predict
With our generated tree we predict some common phrases

```{r predictFunction, echo=FALSE}
# nGramTree.sort <- compiler::cmpfun( nGramTree.sort )
# env2list <- compiler::cmpfun( env2list )

fileName <- paste0(objPre, 'gList') 
# Rprof('listMake.out')
system.time({gList <- env2list(gramTree$tree)}) #faster and smaller to change to List and then save
system.time({save(gList, file = fileName)})
# Rprof(NULL)
# Rprof('listSort.out')
system.time({gList <- nGramTree.sort(gList)})
system.time({save(gList, file = fileName)})
# Rprof(NULL)
pryr::object_size(gramTree$tree)
pryr::object_size(gList)
system.time({gList <- env2Namedlist(gramTree$tree, termsToInclude, sorted = TRUE)})
pryr::object_size(gList)
```

```{r test}
source(paste0(scriptPath, 'refs/refPredRaw.R'))
formals(nGramTree.predict)$k <- maxGram
formals(nGramTree.predict)$commonTerms <- termsToInclude
treeSearch <- compiler::cmpfun( treeSearch )
nGramTree.predict <- compiler::cmpfun( nGramTree.predict )


nGramTree.predict( gramTree, 'the', maxGram )[1:5]
nGramTree.predict( gramTree, 'in', maxGram )[1:5]
nGramTree.predict( gramTree, 'of', maxGram )[1:5]
nGramTree.predict( gramTree, 'case of', maxGram )[1:5]
nGramTree.predict( gramTree, 'a case of', maxGram )[1:5]

```


```{r}
quiz <- c("The guy in front of me just bought a pound of bacon, a bouquet, and a case of",
    "You\'re the reason why I smile everyday. Can you follow me please? It would mean the",
    "Hey sunshine, can you follow me and make me the",
    "Very early observations on the Bills game: Offense still struggling but the",
    "Go on a romantic date at the",
    "Well I'm pretty sure my granny has some old bagpipes in her garage I'll dust them off and be on my",
    "Ohhhhh #PointBreak is on tomorrow. Love that film and haven't seen it in quite some",
    "After the ice bucket challenge Louis will push his long wet hair out of his eyes with his little",
    "Be grateful for the good times and keep the faith during the",
    "If this isn't the cutest thing you've ever seen, then you must be")

```


```{r predict}

lapply(quiz, function(x) nGramTree.predict( gramTree, x, maxGram )[1:5] )


```



## Thoughts
Need to remove grams that resulted from removing uncommon terms from the dataset. 


## references
https://eight2late.wordpress.com/2015/05/27/a-gentle-introduction-to-text-mining-using-r/

http://stackoverflow.com/questions/13614399/how-can-i-use-attr-with-lapply

http://stackoverflow.com/questions/32997201/how-to-store-sparsity-and-maximum-term-length-of-a-term-document-matrix-from-tm

http://www.economist.com/blogs/johnson/2013/05/nVocabulary-size

http://stackoverflow.com/questions/31527345/how-to-add-unequal-length-named-vectors-in-r
